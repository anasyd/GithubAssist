name: Build and Release Extension

on:
  push:
    branches:
      - production
    tags:
      - "v*"
  pull_request:
    branches:
      - production

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Get version from manifest
        id: get_version
        run: |
          VERSION=$(grep '"version"' manifest.json | sed 's/.*"version": *"\([^"]*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create Debug Build
        run: |
          # Create debug directory
          mkdir -p builds/debug

          # Copy all files except .git and builds
          rsync -av --exclude='.git' --exclude='builds' --exclude='.github' --exclude='*.md' --exclude='LICENSE' ./ builds/debug/

          # Ensure debug mode is enabled in debug build
          sed -i 's/const DEBUG_MODE = false;/const DEBUG_MODE = true;/' builds/debug/content.js

          echo "Debug build created with DEBUG_MODE = true"

      - name: Create Production Build
        run: |
          # Create production directory
          mkdir -p builds/production

          # Copy all files except .git and builds
          rsync -av --exclude='.git' --exclude='builds' --exclude='.github' --exclude='*.md' --exclude='LICENSE' ./ builds/production/

          # Ensure debug mode is disabled in production build
          sed -i 's/const DEBUG_MODE = true;/const DEBUG_MODE = false;/' builds/production/content.js

          echo "Production build created with DEBUG_MODE = false"

      - name: Create ZIP files
        run: |
          cd builds

          # Create debug zip
          cd debug
          zip -r "../github-merge-helper-v${{ steps.get_version.outputs.version }}-debug.zip" .
          cd ..

          # Create production zip
          cd production
          zip -r "../github-merge-helper-v${{ steps.get_version.outputs.version }}-production.zip" .
          cd ..

          # List created files
          ls -la *.zip

      - name: Verify builds
        run: |
          echo "=== Debug Build Verification ==="
          grep "DEBUG_MODE" builds/debug/content.js | head -1

          echo "=== Production Build Verification ==="
          grep "DEBUG_MODE" builds/production/content.js | head -1

      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            builds/github-merge-helper-v${{ steps.get_version.outputs.version }}-debug.zip
            builds/github-merge-helper-v${{ steps.get_version.outputs.version }}-production.zip
          body: |
            ## GitHub Merge Conflict Helper v${{ steps.get_version.outputs.version }}

            ### üì¶ Downloads
            - **Production Build**: `github-merge-helper-v${{ steps.get_version.outputs.version }}-production.zip` - Ready for Chrome Web Store
            - **Debug Build**: `github-merge-helper-v${{ steps.get_version.outputs.version }}-debug.zip` - For development and debugging

            ### ‚ú® Features
            - One-click conflict resolution
            - Automatic clipboard copy
            - Branch name detection
            - Works with GitHub's merge conflict editor

            ### üöÄ Installation
            1. Download the production zip file
            2. Extract it to a folder
            3. Open Chrome extensions (chrome://extensions/)
            4. Enable Developer mode
            5. Click "Load unpacked" and select the extracted folder

            ### üêõ Debug Version
            The debug version includes console logging for troubleshooting. Use the production version for normal usage.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Debug Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-build-v${{ steps.get_version.outputs.version }}
          path: builds/github-merge-helper-v${{ steps.get_version.outputs.version }}-debug.zip

      - name: Upload Production Artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-build-v${{ steps.get_version.outputs.version }}
          path: builds/github-merge-helper-v${{ steps.get_version.outputs.version }}-production.zip
